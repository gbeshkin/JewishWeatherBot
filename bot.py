import os
import re
import math
import random
import asyncio
import logging
from dataclasses import dataclass
from datetime import datetime, timedelta, timezone
from typing import Optional, List

import aiohttp
from aiogram import Bot, Dispatcher, Router
from aiogram.filters import Command
from aiogram.types import Message

# -----------------------------
# CONFIG
# -----------------------------
BOT_TOKEN = os.getenv("BOT_TOKEN")
if not BOT_TOKEN:
    raise RuntimeError("BOT_TOKEN env var is missing")

USER_AGENT = os.getenv("USER_AGENT", "JewishWeatherBot/1.0 (contact: you@example.com)")
GDELT_DOC_BASE = os.getenv("GDELT_DOC_BASE", "https://api.gdeltproject.org/api/v2/doc/doc")

# –ó–∞–ø—Ä–æ—Å –º–æ–∂–Ω–æ –ø–æ–¥—Å—Ç—Ä–æ–∏—Ç—å —á–µ—Ä–µ–∑ env, –Ω–æ –¥–µ—Ñ–æ–ª—Ç —É–∂–µ –Ω–æ—Ä–º–∞–ª—å–Ω—ã–π
PROTEST_QUERY = os.getenv(
    "PROTEST_QUERY",
    '"pro palestinian" OR "pro-palestinian" OR "pro palestine" OR '
    '"palestine rally" OR "palestine protest" OR "pro-palestine protest" OR '
    '"palestinian solidarity" OR "solidarity with palestine" OR '
    '"ceasefire protest" OR "gaza protest" OR "free palestine rally"'
)

WINDOW_HOURS = 24
MAX_ARTICLES = int(os.getenv("MAX_ARTICLES", "80"))

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger("protest-forecast-bot")
router = Router()


# -----------------------------
# MODELS
# -----------------------------
@dataclass
class Article:
    title: str
    url: str
    seendate: datetime
    source_country: Optional[str]


# -----------------------------
# HELPERS
# -----------------------------
def now_utc() -> datetime:
    return datetime.now(timezone.utc)


def clamp(x: float, lo: float, hi: float) -> float:
    return max(lo, min(hi, x))


def sigmoid(x: float) -> float:
    return 1.0 / (1.0 + math.exp(-x))


def human_city(s: str) -> str:
    s = re.sub(r"\s+", " ", s.strip())
    return s[:80]


def maybe(p: float) -> bool:
    return random.random() < p


def pick(items: List[str]) -> str:
    return random.choice(items)


def _gdelt_start_datetime(hours_back: int) -> str:
    dt = now_utc() - timedelta(hours=hours_back)
    return dt.strftime("%Y%m%d%H%M%S")


def _parse_seendate(s: str) -> datetime:
    s = (s or "").replace("T", " ").replace("Z", "")
    s = re.sub(r"\.\d+$", "", s).strip()
    for fmt in ("%Y-%m-%d %H:%M:%S", "%Y%m%d%H%M%S"):
        try:
            return datetime.strptime(s, fmt).replace(tzinfo=timezone.utc)
        except Exception:
            pass
    return now_utc()


async def _gdelt_get_json_tolerant(resp: aiohttp.ClientResponse) -> dict:
    """
    GDELT –∏–Ω–æ–≥–¥–∞ –æ—Ç–≤–µ—á–∞–µ—Ç text/html –¥–∞–∂–µ –ø—Ä–∏ 200.
    –ú—ã –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º content-type –∏ –ø—ã—Ç–∞–µ–º—Å—è —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å, –∏–Ω–∞—á–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º {}.
    """
    try:
        return await resp.json(content_type=None)
    except Exception:
        try:
            body = await resp.text()
        except Exception:
            body = "<unreadable>"
        logger.warning(
            "GDELT non-JSON (status=%s ct=%s): %s",
            resp.status,
            resp.headers.get("Content-Type"),
            body[:200].replace("\n", " "),
        )
        return {}


async def gdelt_fetch_articles(session: aiohttp.ClientSession, city: str) -> List[Article]:
    startdt = _gdelt_start_datetime(WINDOW_HOURS)
    query = f"({PROTEST_QUERY}) AND ({city})"

    params = {
        "query": query,
        "mode": "ArtList",
        "format": "json",
        "sort": "DateDesc",
        "maxrecords": str(MAX_ARTICLES),
        "startdatetime": startdt,
    }

    async with session.get(
        GDELT_DOC_BASE,
        params=params,
        headers={"User-Agent": USER_AGENT},
        timeout=25
    ) as resp:
        if resp.status != 200:
            txt = await resp.text()
            logger.warning("GDELT HTTP %s: %s", resp.status, txt[:200].replace("\n", " "))
            return []
        data = await _gdelt_get_json_tolerant(resp)

    arts: List[Article] = []
    for item in (data.get("articles") or []):
        title = item.get("title") or ""
        url = item.get("url") or ""
        seendate = _parse_seendate(item.get("seendate", ""))
        source_country = item.get("sourceCountry")
        if title and url:
            arts.append(Article(title=title, url=url, seendate=seendate, source_country=source_country))
    return arts


# -----------------------------
# METRICS (24h only)
# -----------------------------
def compute_metrics(articles_24h: List[Article]) -> dict:
    """
    –í—Å—ë —Ç–æ–ª—å–∫–æ –ø–æ 24 —á–∞—Å–∞–º:
    - n: —Å–∫–æ–ª—å–∫–æ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –Ω–∞–π–¥–µ–Ω–æ –≤ –Ω–æ–≤–æ—Å—Ç–Ω–æ–π –±–∞–∑–µ –ø–æ –∑–∞–ø—Ä–æ—Å—É (–≥–æ—Ä–æ–¥ + –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞)
    """
    n = len(articles_24h)

    precipitation = clamp(1.0 - math.exp(-n / 6.0), 0.0, 1.0)
    wind = clamp(sigmoid((n - 4.0) * 0.7), 0.0, 1.0)

    countries = [a.source_country for a in articles_24h if a.source_country]
    diversity = len(set(countries))
    pressure = clamp(1.0 - math.exp(-diversity / 4.0), 0.0, 1.0)

    temperature = clamp(0.55 * precipitation + 0.30 * wind + 0.15 * pressure, 0.0, 1.0)
    confidence = clamp(1.0 - math.exp(-n / 5.5), 0.0, 1.0)

    return {
        "n": float(n),
        "precipitation": precipitation,
        "wind": wind,
        "pressure": pressure,
        "temperature": temperature,
        "confidence": confidence,
    }


def lvl3(x: float, a: float, b: float, low: str, mid: str, high: str) -> str:
    if x < a:
        return low
    if x < b:
        return mid
    return high


def words(metrics: dict) -> dict:
    precip = lvl3(metrics["precipitation"], 0.25, 0.65, "–Ω–∏–∑–∫–∞—è", "—É–º–µ—Ä–µ–Ω–Ω–∞—è", "–≤—ã—Å–æ–∫–∞—è")
    wind = lvl3(metrics["wind"], 0.25, 0.65, "—Å–ª–∞–±—ã–π", "–∑–∞–º–µ—Ç–Ω—ã–π", "–ø–æ—Ä—ã–≤–∏—Å—Ç—ã–π")
    press = lvl3(metrics["pressure"], 0.25, 0.65, "—Å–ø–æ–∫–æ–π–Ω–æ–µ", "–ø–µ—Ä–µ–º–µ–Ω–Ω–æ–µ", "–Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ–µ")

    t = metrics["temperature"]
    temp = lvl3(t, 0.30, 0.75, "–ø—Ä–æ—Ö–ª–∞–¥–Ω–∞—è", "—Ç—ë–ø–ª–∞—è", "–≥–æ—Ä—è—á–∞—è")
    if t > 0.88:
        temp = "–ø–µ—Ä–µ–≥—Ä–µ—Ç–∞—è"

    conf = lvl3(metrics["confidence"], 0.35, 0.75, "–Ω–∏–∑–∫–∞—è", "—Å—Ä–µ–¥–Ω—è—è", "–≤—ã—Å–æ–∫–∞—è")
    return {"precip": precip, "wind": wind, "press": press, "temp": temp, "conf": conf}


# -----------------------------
# TEXT ENGINE (HUGE VARIETY)
# -----------------------------
ANCHORS = [
    "‚òÅÔ∏è –ü—Ä–æ–≥–Ω–æ–∑ –æ–±—â–µ—Å—Ç–≤–µ–Ω–Ω–æ–π –ø–æ–≥–æ–¥—ã",
    "üå¶ –ü–æ–ª–∏—Ç–∏–∫–æ-–º–µ—Ç–µ–æ—Å–≤–æ–¥–∫–∞",
    "‚õÖ –ü—Ä–æ–≥–Ω–æ–∑ –ø–æ –∞—Ç–º–æ—Å—Ñ–µ—Ä–Ω—ã–º –æ–±—Å—É–∂–¥–µ–Ω–∏—è–º",
    "üå§ –ì–æ—Ä–æ–¥—Å–∫–∞—è –ø–æ–≥–æ–¥–Ω–∞—è —Å–≤–æ–¥–∫–∞ –ø–æ –ø–æ–≤–µ—Å—Ç–∫–µ",
    "üå• –ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–π –∏ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤",
    "üõ∞ –°–≤–æ–¥–∫–∞ —Å —Ä–∞–¥–∞—Ä–∞ –ª–µ–Ω—Ç—ã",
    "üì° –û–±–ª–∞—á–Ω—ã–π –±—é–ª–ª–µ—Ç–µ–Ω—å –Ω–æ–≤–æ—Å—Ç–µ–π",
    "üåß –°–≤–æ–¥–∫–∞ –ø–æ –æ—Å–∞–¥–∫–∞–º —Å–º—ã—Å–ª–∞",
    "üå™ –°–∏–Ω–æ–ø—Ç–∏—á–µ—Å–∫–∞—è –∫–∞—Ä—Ç–∞ –¥–∏—Å–∫—É—Å—Å–∏–π",
    "üåà –ü—Ä–æ–≥–Ω–æ–∑: —à–∞–Ω—Å –Ω–∞ —Å–≤–µ—Ç —Å—Ä–µ–¥–∏ –æ–±–ª–∞–∫–æ–≤",
    "üóû –ü–æ–≥–æ–¥–Ω–∞—è —Å–≤–æ–¥–∫–∞ —Ä–µ–¥–∞–∫—Ü–∏–∏ ¬´–ù–µ –∫–∏–ø—è—Ç–∏—Å—å¬ª",
    "üß≠ –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –≤–µ—Ç—Ä–∞–º –ø–æ–≤–µ—Å—Ç–∫–∏",
    "üå´ –ú–µ—Ç–µ–æ—Ä–æ–ª–æ–≥–∏—è –æ–±—â–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤",
    "üß† –ü—Ä–æ–≥–Ω–æ–∑ –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–≥–æ –º—ã—à–ª–µ–Ω–∏—è",
    "üìª –†–∞–¥–∏–æ—Å–≤–æ–¥–∫–∞ ¬´–ü–æ–≥–æ–¥–∞: –°–ª–æ–≤–∞¬ª",
    "üïØÔ∏è –ü—Ä–æ–≥–Ω–æ–∑ —Å –ø—Ä–∏–º–µ—Å—å—é —Å–≤–µ—á–Ω–æ–≥–æ —Å–≤–µ—Ç–∞",
]

VOICE_TAGS = [
    "–ì–æ–≤–æ—Ä–∏—Ç –º–µ—Ç–µ–æ—Å—Ç–∞–Ω—Ü–∏—è –∑–¥—Ä–∞–≤–æ–≥–æ —Å–º—ã—Å–ª–∞.",
    "–ù–∞ —Å–≤—è–∑–∏ —Å–∏–Ω–æ–ø—Ç–∏–∫–∏ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏.",
    "–ü–µ—Ä–µ–¥–∞—ë–º —Å —Ñ—Ä–æ–Ω—Ç–∞ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤.",
    "–î–æ–∫–ª–∞–¥ —Å –±–∞–ª–∫–æ–Ω–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–≥–æ –º—ã—à–ª–µ–Ω–∏—è.",
    "–°–≤–æ–¥–∫–∞ —Å –º–µ—Ç–µ–æ—Ä–∞–¥–∞—Ä–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤.",
    "–°–ª—É–∂–±–∞ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è –∑–∞ –ø–æ–≤–µ—Å—Ç–∫–æ–π —Å–æ–æ–±—â–∞–µ—Ç.",
    "–û—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ-–Ω–µ–æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è –º–µ—Ç–µ–æ—Å–ª—É–∂–±–∞: –≤–Ω–∏–º–∞–Ω–∏–µ.",
    "–û—Ç–¥–µ–ª –ø—Ä–æ–≥–Ω–æ–∑–æ–≤: ¬´–°–Ω–∞—á–∞–ª–∞ —Ñ–∞–∫—Ç—ã¬ª.",
    "–î–µ–∂—É—Ä–Ω—ã–π —Å–∏–Ω–æ–ø—Ç–∏–∫ —ç–º–æ—Ü–∏–π –¥–æ–∫–ª–∞–¥—ã–≤–∞–µ—Ç.",
    "–ü—Ä—è–º–æ–µ –≤–∫–ª—é—á–µ–Ω–∏–µ –∏–∑ —Ü–∏–∫–ª–æ–Ω–∞ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–π.",
    "–®—Ç–∞–± –ø–æ –±–æ—Ä—å–±–µ —Å –ø–µ—Ä–µ–≥—Ä–µ–≤–æ–º —Å–æ–æ–±—â–∞–µ—Ç.",
    "–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è ¬´–ì—Ä–æ–º–∫–æ—Å—Ç—å ‚â† –ò—Å—Ç–∏–Ω–∞¬ª –Ω–∞ –ª–∏–Ω–∏–∏.",
    "–£ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ —Ä–µ–¥–∞–∫—Ü–∏—è ¬´–ü—Ä–æ–≤–µ—Ä—è–π –ø–µ—Ä–≤–æ–∏—Å—Ç–æ—á–Ω–∏–∫¬ª.",
    "–°–≤–æ–¥–∫–∞ –ø–æ –∫–ª–∏–º–∞—Ç—É –ª–µ–Ω—Ç—ã: –∫–æ—Ä–æ—Ç–∫–æ –∏ –±–µ–∑ –ø–∞–Ω–∏–∫–∏.",
    "–†–∞–¥–∏–æ ¬´–¢–∏—Ö–∏–π —Ä–∞–∑—É–º¬ª: –≤—ã–ø—É—Å–∫ —Å—Ä–æ—á–Ω—ã–π, –Ω–æ —Å–ø–æ–∫–æ–π–Ω—ã–π.",
]

OPENERS = [
    "–ó–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞ –≤–æ–∑–¥—É—Ö –∑–∞–º–µ—Ç–Ω–æ –Ω–∞—ç–ª–µ–∫—Ç—Ä–∏–∑–æ–≤–∞–ª—Å—è —Å–ª–æ–≤–∞–º–∏.",
    "–ó–∞ —Å—É—Ç–∫–∏ –≤ –∞—Ç–º–æ—Å—Ñ–µ—Ä–µ –Ω–∞–∫–æ–ø–∏–ª–æ—Å—å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —à—É–º–∞, —á—Ç–æ–±—ã –æ–Ω –Ω–∞—á–∞–ª –∫–∞–∑–∞—Ç—å—Å—è –ø–æ–≥–æ–¥–æ–π.",
    "–ü–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞: –ª–µ–Ω—Ç–∞ –≤–µ–¥—ë—Ç —Å–µ–±—è –∫–∞–∫ –∫–ª–∏–º–∞—Ç, –Ω–æ —ç—Ç–æ –≤—Å—ë –µ—â—ë —ç–º–æ—Ü–∏–∏.",
    "–°—É—Ç–∫–∏ –±—ã–ª–∏ –Ω–∞—Å—ã—â–µ–Ω—ã —É–ø–æ–º–∏–Ω–∞–Ω–∏—è–º–∏ ‚Äî –º–µ—Å—Ç–∞–º–∏ —Å —ç—Ñ—Ñ–µ–∫—Ç–æ–º –≥—Ä–æ–º–∞ –±–µ–∑ –¥–æ–∂–¥—è.",
    "–°—É—Ç–æ—á–Ω—ã–π –ø—Ä–æ–≥–Ω–æ–∑: –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –æ—Ü–µ–Ω–∏–≤–∞–µ—Ç—Å—è –ø–æ –ø—É–±–ª–∏—á–Ω—ã–º —Å–∏–≥–Ω–∞–ª–∞–º.",
    "–ü–æ–≥–æ–¥–∞ —Å–µ–≥–æ–¥–Ω—è –∏–∑ —Ç–µ—Ö, —á—Ç–æ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –≤ —Ç–µ–ª–µ—Ñ–æ–Ω–µ –∏ –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –≤ –≥–æ–ª–æ–≤–µ.",
    "–ï—Å–ª–∏ –∫–∞–∂–µ—Ç—Å—è, —á—Ç–æ –≤—Å—ë ¬´–≤–æ—Ç-–≤–æ—Ç¬ª ‚Äî –≤–æ–∑–º–æ–∂–Ω–æ, —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ –¥–∞–≤–ª–µ–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤.",
    "–í —Ç–µ—á–µ–Ω–∏–µ —Å—É—Ç–æ–∫ –∑–∞–º–µ—á–µ–Ω—ã –æ–±–ª–∞–∫–∞ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–π –∏ —Ç—É–º–∞–Ω –æ–±–æ–±—â–µ–Ω–∏–π.",
    "–°–≤–æ–¥–∫–∞ –∑–∞ —Å—É—Ç–∫–∏: –º–Ω–æ–≥–æ —Å–ª–æ–≤, –º–∞–ª–æ –≤–æ–∑–¥—É—Ö–∞. –î—ã—à–∏–º.",
    "–û—Ç–º–µ—á–µ–Ω—ã –ª–æ–∫–∞–ª—å–Ω—ã–µ –∑–∞–≤–∏—Ö—Ä–µ–Ω–∏—è –≤ –ø–æ–≤–µ—Å—Ç–∫–µ. –ü–∞–Ω–∏–∫–µ –≤—Ö–æ–¥ –≤–æ—Å–ø—Ä–µ—â—ë–Ω.",
]

MORNING_TEMPLATES = [
    "–£—Ç—Ä–æ–º –≤–µ—Ä–æ—è—Ç–Ω—ã {phenomenon} ‚Äî —è–≤–ª–µ–Ω–∏–µ {desc}.",
    "–° —É—Ç—Ä–∞ –≤–æ–∑–º–æ–∂–Ω—ã {phenomenon}: {desc}.",
    "–ü–µ—Ä–≤–∞—è –ø–æ–ª–æ–≤–∏–Ω–∞ –¥–Ω—è –æ–±–µ—â–∞–µ—Ç {phenomenon}. –ü–æ –æ—â—É—â–µ–Ω–∏—è–º ‚Äî {desc}.",
    "–ù–∞ —É—Ç—Ä–µ–Ω–Ω–µ–º –≥–æ—Ä–∏–∑–æ–Ω—Ç–µ: {phenomenon}. –•–∞—Ä–∞–∫—Ç–µ—Ä: {desc}.",
    "–£—Ç—Ä–æ –ø—Ä–∏–Ω–æ—Å–∏—Ç {phenomenon}, –∏ —ç—Ç–æ {desc}.",
    "–£—Ç—Ä–µ–Ω–Ω–∏–π —Ñ—Ä–æ–Ω—Ç: {phenomenon}. –°–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏–µ ‚Äî {desc}.",
    "–í —É—Ç—Ä–µ–Ω–Ω–∏–µ —á–∞—Å—ã –≤–µ—Ä–æ—è—Ç–Ω—ã {phenomenon}. –°—Ü–µ–Ω–∞—Ä–∏–π: {desc}.",
]

PHENOMENA = [
    "–ª–æ–∫–∞–ª—å–Ω—ã–µ –≤—ã—Å—Ç—É–ø–ª–µ–Ω–∏—è –∏ –º–∏—Ç–∏–Ω–≥–æ–≤–∞—è –ø–æ–≤–µ—Å—Ç–∫–∞",
    "—Ç–æ—á–µ—á–Ω—ã–µ –≤—Å–ø–ª–µ—Å–∫–∏ —É–ª–∏—á–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏",
    "–≤–æ–ª–Ω—ã —Å–æ–ª–∏–¥–∞—Ä–Ω–æ—Å—Ç–∏ –∏ –≤—Å—Ç—Ä–µ—á–Ω—ã–µ —Ç–µ—á–µ–Ω–∏—è",
    "—Å–∫–æ–ø–ª–µ–Ω–∏—è –ª—é–¥–µ–π –≤–æ–∫—Ä—É–≥ –≥—Ä–æ–º–∫–∏—Ö —Ç–µ–º",
    "–ø–æ—Ä—ã–≤—ã –ø–ª–∞–∫–∞—Ç–æ–≤ –∏ –ª–æ–∑—É–Ω–≥–æ–≤ (–º–µ—Å—Ç–∞–º–∏)",
    "–æ–±–ª–∞—á–Ω–æ—Å—Ç—å –∏–∑ –ø—Ä–∏–∑—ã–≤–æ–≤ –∏ –∫–æ–Ω—Ç—Ä–ø—Ä–∏–∑—ã–≤–æ–≤",
    "–ª–æ–∫–∞–ª—å–Ω—ã–µ —Å–≥—É—â–µ–Ω–∏—è –≤–æ–∫—Ä—É–≥ —Å–∏–º–≤–æ–ª–æ–≤ –∏ –ª–æ–∑—É–Ω–≥–æ–≤",
    "–∫–∞—Ä–º–∞–Ω—ã –Ω–∞–ø—Ä—è–∂—ë–Ω–Ω–æ—Å—Ç–∏ –Ω–∞ –∫–∞—Ä—Ç–µ –æ–±—Å—É–∂–¥–µ–Ω–∏–π",
]

DESCS = [
    "—à—É–º–Ω–æ–µ, –Ω–æ –æ–±—ã—á–Ω–æ –∫—Ä–∞—Ç–∫–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ",
    "–≤–∏–∑—É–∞–ª—å–Ω–æ –ø–ª–æ—Ç–Ω–æ–µ, –Ω–æ —á–∞—Å—Ç–æ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–µ",
    "—ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –≥—Ä–æ–º–∫–æ–µ, –Ω–æ –Ω–µ –≤—Å–µ–≥–¥–∞ –¥–ª–∏—Ç–µ–ª—å–Ω–æ–µ",
    "—Å –æ—Ç—Ç–µ–Ω–∫–æ–º ¬´—Å–µ–π—á–∞—Å-—Å–µ–π—á–∞—Å¬ª –∏ –±—ã—Å—Ç—Ä—ã–º —Ä–∞—Å—Å–µ–∏–≤–∞–Ω–∏–µ–º",
    "–ø–æ—Ö–æ–∂–µ–µ –Ω–∞ –≥—Ä–æ–∑—É: –º–Ω–æ–≥–æ –∑–≤—É–∫–∞, –º–∞–ª–æ –æ—Å–∞–¥–∫–æ–≤",
    "—Ç–æ —Å–≥—É—â–∞–µ—Ç—Å—è, —Ç–æ –∏—Å—á–µ–∑–∞–µ—Ç ‚Äî –∫–∞–∫ –±—É–¥—Ç–æ —Å–∞–º–æ —Å–æ–º–Ω–µ–≤–∞–µ—Ç—Å—è",
    "—Å–∏–ª—å–Ω–µ–µ –Ω–∞ —ç–∫—Ä–∞–Ω–µ, —á–µ–º –Ω–∞ —É–ª–∏—Ü–µ ‚Äî –Ω–æ –≤—Å—ë —Ä–∞–≤–Ω–æ –∑–∞–º–µ—Ç–Ω–æ–µ",
]

DAY_TEMPLATES = [
    "–î–Ω—ë–º –æ–∂–∏–¥–∞—é—Ç—Å—è {day_event}; —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è {advice}.",
    "–ü–æ—Å–ª–µ –æ–±–µ–¥–∞ –≤–æ–∑–º–æ–∂–Ω—ã {day_event}. –ù–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π ‚Äî {advice}.",
    "–í–æ –≤—Ç–æ—Ä–æ–π –ø–æ–ª–æ–≤–∏–Ω–µ –¥–Ω—è ‚Äî {day_event}. –õ—É—á—à–µ –¥–µ—Ä–∂–∞—Ç—å —Ä—è–¥–æ–º: {advice}.",
    "–ö —Å–µ—Ä–µ–¥–∏–Ω–µ –¥–Ω—è –ø–æ–¥–Ω–∏–º–∞—é—Ç—Å—è {day_event}. –ü—Ä–∞–∫—Ç–∏–∫–∞ –¥–Ω—è: {advice}.",
    "–î–Ω–µ–≤–Ω–æ–π —Ñ–æ–Ω: {day_event}. –°–æ–≤–µ—Ç: {advice}.",
    "–î–Ω—ë–º ‚Äî {day_event}. –ú–µ—Ç–µ–æ–∑–∞—â–∏—Ç–∞: {advice}.",
]

DAY_EVENTS = [
    "–ø–æ—Ä—ã–≤—ã ¬´breaking news¬ª",
    "–æ–±–ª–∞–∫–∞ —Å—Ä–æ—á–Ω—ã—Ö –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–π",
    "—Ä–µ–∑–∫–∏–µ —Å–º–µ–Ω—ã –≤–µ—Ç—Ä–∞ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–∞—Ö",
    "–≤—Å–ø—ã—à–∫–∏ —Å–ø–æ—Ä–Ω—ã—Ö —Ç–µ–∑–∏—Å–æ–≤",
    "–ª–∏–≤–Ω–∏ –∏–∑ ¬´—ç–∫—Å–ø–µ—Ä—Ç–Ω—ã—Ö¬ª –≤—ã–≤–æ–¥–æ–≤",
    "–ø–µ—Ä–µ–ø–∞–¥—ã —Ç–æ–Ω–∞ –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è—Ö",
    "–ø–µ—Ä–µ–æ—Ö–ª–∞–∂–¥–µ–Ω–∏–µ —Ñ–∞–∫—Ç–æ–≤ –∏ –ø–µ—Ä–µ–≥—Ä–µ–≤ –º–Ω–µ–Ω–∏–π",
    "—Ü–∏–∫–ª–æ–Ω ¬´–≤—Å–µ –∑–Ω–∞—é—Ç –∫–∞–∫ –Ω–∞–¥–æ¬ª",
    "—Ç—É–º–∞–Ω ¬´–∫–æ–Ω—Ç–µ–∫—Å—Ç –Ω–µ –Ω—É–∂–µ–Ω¬ª",
    "–≥—Ä–∞–¥ ¬´–æ—á–µ–≤–∏–¥–Ω—ã—Ö¬ª –≤—ã–≤–æ–¥–æ–≤ –±–µ–∑ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤",
]

ADVICES = [
    "–∑–æ–Ω—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–≥–æ –º—ã—à–ª–µ–Ω–∏—è",
    "–∫—É—Ä—Ç–∫—É –∑–¥—Ä–∞–≤–æ–≥–æ —Å–º—ã—Å–ª–∞",
    "–ø–∞—É–∑—É –º–µ–∂–¥—É ¬´—É–≤–∏–¥–µ–ª¬ª –∏ ¬´–ø–æ–≤–µ—Ä–∏–ª¬ª",
    "–ø—Ä–æ–≤–µ—Ä–∫—É –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –ø–µ—Ä–µ–¥ —Ä–µ–ø–æ—Å—Ç–æ–º",
    "–æ–≥—Ä–∞–Ω–∏—á–∏—Ç–µ–ª—å –Ω–æ–≤–æ—Å—Ç–Ω–æ–≥–æ —Å–∫—Ä–æ–ª–ª–∞",
    "—Ç—ë–ø–ª—ã–π —á–∞–π –∏ —Ö–æ–ª–æ–¥–Ω—É—é –≥–æ–ª–æ–≤—É",
    "–ø—Ä–∞–≤–∏–ª–æ –¥–≤—É—Ö –≤–∫–ª–∞–¥–æ–∫: —Ñ–∞–∫—Ç + –ø–µ—Ä–≤–æ–∏—Å—Ç–æ—á–Ω–∏–∫",
    "—Ä–µ–∂–∏–º ¬´–Ω–µ —Å–ø–æ—Ä—é –Ω–∞ –≥–æ–ª–æ–¥–Ω—ã–π –º–æ–∑–≥¬ª",
]

EVENING_TEMPLATES = [
    "–ö –≤–µ—á–µ—Ä—É –≤–æ–∑–º–æ–∂–µ–Ω {evening}: {evening_desc}.",
    "–ë–ª–∏–∂–µ –∫ –≤–µ—á–µ—Ä—É ‚Äî {evening}. –ò—Ç–æ–≥: {evening_desc}.",
    "–í–µ—á–µ—Ä–æ–º –ø—Ä–∏—Ö–æ–¥–∏—Ç {evening} ‚Äî –∏ {evening_desc}.",
    "–ö –Ω–æ—á–∏ –≤–µ—Ä–æ—è—Ç–µ–Ω {evening}. –û–±—ã—á–Ω–æ —ç—Ç–æ –∫–æ–≥–¥–∞ {evening_desc}.",
    "–§–∏–Ω–∞–ª –¥–Ω—è: {evening}. –≠—Ç–æ –∑–Ω–∞—á–∏—Ç ‚Äî {evening_desc}.",
]

EVENINGS = [
    "—à–∞–±–±–∞—Ç-–±—Ä–∏–∑",
    "–∑–∞—Ç–∏—à—å–µ –≤–Ω–µ –ª–µ–Ω—Ç—ã",
    "—Ä–µ–∂–∏–º ¬´–æ—Ç–ª–æ–∂–µ–Ω–Ω—ã–µ –Ω–æ–≤–æ—Å—Ç–∏¬ª",
    "–≤–æ–∑–≤—Ä–∞—Ç –∫ —á–µ–ª–æ–≤–µ—á–µ—Å–∫–æ–º—É –º–∞—Å—à—Ç–∞–±—É",
    "—Ç–∏—Ö–∞—è –ø–∞—É–∑–∞ –≤ —Å–ø–æ—Ä–µ",
    "–≤–µ—á–µ—Ä–Ω—è—è —Ç–∏—à–∏–Ω–∞ –±–µ–∑ —Å—Ä–æ—á–Ω–æ—Å—Ç–∏",
    "–ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å ¬´–∫—Ç–æ –ø—Ä–∞–≤¬ª –Ω–∞ ¬´–∫–∞–∫ —Ç—ã?¬ª",
]

EVENING_DESCS = [
    "—à—É–º —Å—Ç–∏—Ö–∞–µ—Ç, –∞ —Å–º—ã—Å–ª —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —Å–ª—ã—à–Ω–µ–µ",
    "—Ç–µ–º–ø –ø–∞–¥–∞–µ—Ç, –∏ —Ö–æ—á–µ—Ç—Å—è –≥–æ–≤–æ—Ä–∏—Ç—å —Ç–∏—à–µ",
    "–ø–æ—è–≤–ª—è–µ—Ç—Å—è —à–∞–Ω—Å –Ω–∞ –Ω–æ—Ä–º–∞–ª—å–Ω—ã–µ —Å–ª–æ–≤–∞",
    "–≤–¥—Ä—É–≥ –æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è, —á—Ç–æ –ª—é–¥–∏ –≤–∞–∂–Ω–µ–µ –¥–∏—Å–∫—É—Å—Å–∏–π",
    "–∑–∞–≥–æ–ª–æ–≤–∫–∏ –æ—Ç–∫–ª–∞–¥—ã–≤–∞—é—Ç—Å—è, –∞ –∂–∏–∑–Ω—å –æ—Å—Ç–∞—ë—Ç—Å—è",
    "–º–æ–∂–Ω–æ –∑–∞–∂–µ—á—å —Å–≤–µ—Ç ‚Äî –∏ –Ω–µ –¥–æ–∫–∞–∑—ã–≤–∞—Ç—å –µ–≥–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å",
]

METRIC_TEMPLATES = [
    "üå° –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –æ–±—â–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –º–Ω–µ–Ω–∏—è ‚Äî **{temp}**.\nüå¨ –í–µ—Ç–µ—Ä –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ ‚Äî **{wind}**.\nüåç –ú–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω–æ–µ –¥–∞–≤–ª–µ–Ω–∏–µ ‚Äî **{press}**.",
    "üå° –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞: **{temp}** | üå¨ –í–µ—Ç–µ—Ä: **{wind}** | üåç –î–∞–≤–ª–µ–Ω–∏–µ: **{press}**.",
    "üå° –ü–æ –æ—â—É—â–µ–Ω–∏—è–º: **{temp}**.\nüå¨ –ü–æ—Ä—ã–≤—ã: **{wind}**.\nüåç –î–∞–≤–ª–µ–Ω–∏–µ: **{press}**.",
    "üå° –¢–µ—Ä–º–æ–º–µ—Ç—Ä —ç–º–æ—Ü–∏–π: **{temp}**.\nüå¨ –ê–Ω–µ–º–æ–º–µ—Ç—Ä –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤: **{wind}**.\nüåç –ë–∞—Ä–æ–º–µ—Ç—Ä –≤–Ω–µ—à–Ω–µ–≥–æ –¥–∞–≤–ª–µ–Ω–∏—è: **{press}**.",
]

RADAR_HEADERS = [
    "üì° –†–∞–¥–∞—Ä –∑–∞ 24 —á–∞—Å–∞",
    "üõ∞ –†–∞–¥–∞—Ä —Å—É—Ç–æ–∫",
    "üìç –°—É—Ç–æ—á–Ω—ã–µ —Å–∏–≥–Ω–∞–ª—ã",
    "üóû –ò–Ω–¥–µ–∫—Å –ª–µ–Ω—Ç—ã –∑–∞ —Å—É—Ç–∫–∏",
    "üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ 24 —á–∞—Å–∞",
    "üîî –î–µ—Ç–µ–∫—Ç–æ—Ä —É–ø–æ–º–∏–Ω–∞–Ω–∏–π",
]

RADAR_LINES = [
    "–ù–∞–π–¥–µ–Ω–æ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –ø–æ –∑–∞–ø—Ä–æ—Å—É (–≥–æ—Ä–æ–¥ + –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞): **{n}**.",
    "–ü—É–±–ª–∏—á–Ω—ã—Ö –Ω–æ–≤–æ—Å—Ç–Ω—ã—Ö —Å–∏–≥–Ω–∞–ª–æ–≤ –∑–∞ 24 —á–∞—Å–∞: **{n}**.",
    "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π –≤ –Ω–æ–≤–æ—Å—Ç–Ω–æ–π –±–∞–∑–µ –∑–∞ —Å—É—Ç–∫–∏: **{n}**.",
    "–ò–Ω–¥–µ–∫—Å —Å–∏–≥–Ω–∞–ª–æ–≤ –∑–∞ —Å—É—Ç–∫–∏: **{n}** (—ç—Ç–æ —á–∏—Å–ª–æ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤).",
]

CONF_TEMPLATES = [
    "üîé –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –ø—Ä–æ–≥–Ω–æ–∑–∞: **{conf}** (–±–æ–ª—å—à–µ —Å–∏–≥–Ω–∞–ª–æ–≤ ‚Üí –≤—ã—à–µ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å).",
    "üîé –ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å –æ—Ü–µ–Ω–∫–∏: **{conf}**.",
    "üîé –î–æ–≤–µ—Ä–∏–µ –∫ –ø—Ä–æ–≥–Ω–æ–∑—É: **{conf}**.",
    "üîé –ö–∞—á–µ—Å—Ç–≤–æ —Å–∏–≥–Ω–∞–ª–∞: **{conf}**.",
]

ASIDES = [
    "üß≤ –ú–∞–≥–Ω–∏—Ç–Ω—ã—Ö –±—É—Ä—å –Ω–µ –æ–∂–∏–¥–∞–µ—Ç—Å—è, –Ω–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ ‚Äî –≤–æ–∑–º–æ–∂–Ω—ã.",
    "ü™ü –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ç—Ä–∏—Ç—å –ª–µ–Ω—Ç—É –∏ –∑–∞–∫—Ä—ã—Ç—å –≤–∫–ª–∞–¥–∫–∏ —Å–æ —Å–ª—É—Ö–∞–º–∏.",
    "üßä –û—Å—Ç–æ—Ä–æ–∂–Ω–æ: –ª—ë–¥ –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è—Ö. –î–µ—Ä–∂–∏—Ç–µ—Å—å –±–ª–∏–∂–µ –∫ —Ñ–∞–∫—Ç–∞–º.",
    "üßØ –ü—Ä–∏ –ø–µ—Ä–µ–≥—Ä–µ–≤–µ ‚Äî –≤—ã–∫–ª—é—á–∏—Ç—å —Å–ø–æ—Ä –∏ –≤–∫–ª—é—á–∏—Ç—å –¥—ã—Ö–∞–Ω–∏–µ.",
    "üß† –ü–æ–±–æ—á–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç –Ω–æ–≤–æ—Å—Ç–µ–π: —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –±–µ–∑ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤.",
    "üßæ –ï—Å–ª–∏ –∫—Ç–æ-—Ç–æ –∫—Ä–∏—á–∏—Ç ¬´–≤—Å—ë –æ—á–µ–≤–∏–¥–Ω–æ¬ª ‚Äî –ø—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –∏–º–µ–Ω–Ω–æ.",
    "üßò –ú–∏–Ω–∏–º—É–º: –Ω–µ —Å–ø–æ—Ä–∏—Ç—å –≤ –º–æ–º–µ–Ω—Ç–µ. –ú–∞–∫—Å–∏–º—É–º: –±—ã—Ç—å —á–µ–ª–æ–≤–µ–∫–æ–º.",
]

MICRO_SECTIONS = [
    "üß© –ò–Ω–æ–≥–¥–∞ –∑–∞–≥–æ–ª–æ–≤–æ–∫ ‚Äî —ç—Ç–æ –æ–±–ª–∞–∫–æ –±–µ–∑ –¥–æ–∂–¥—è. –ù–µ –≤—ã–¥–∞–≤–∞–π—Ç–µ –µ–≥–æ –∑–∞ –∫–ª–∏–º–∞—Ç.",
    "üß∑ –ö–æ—Ä–æ—Ç–∫–æ–µ –ø—Ä–∞–≤–∏–ª–æ: –æ–¥–∏–Ω —Ñ–∞–∫—Ç ‚Äî –¥–≤–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∞.",
    "üß† –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ: –≥—Ä–æ–º–∫–æ—Å—Ç—å ‚Äî –Ω–µ –∞—Ä–≥—É–º–µ–Ω—Ç.",
    "üß≠ –•–æ—Ä–æ—à–∏–π –∫–æ–º–ø–∞—Å: ¬´—á—Ç–æ —è –º–æ–≥—É –ø—Ä–æ–≤–µ—Ä–∏—Ç—å?¬ª",
    "üïØÔ∏è –ï—Å–ª–∏ –¥–µ–Ω—å —Ç—è–∂—ë–ª—ã–π ‚Äî —É–º–µ–Ω—å—à–∏ —Å–∫–æ—Ä–æ—Å—Ç—å. –≠—Ç–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ, –Ω–µ —Å–ª–∞–±–æ—Å—Ç—å.",
]

FINALS = [
    "–ë–µ—Ä–µ–≥–∏ —Å–µ–±—è: –¥–∞–∂–µ –ø–∞—Å–º—É—Ä–Ω–∞—è –ø–æ–≤–µ—Å—Ç–∫–∞ –Ω–µ –æ—Ç–º–µ–Ω—è–µ—Ç —Å–≤–µ—Ç.",
    "–ü–æ–º–Ω–∏: —Å–≤–µ—Ç –Ω–µ —Ç—Ä–µ–±—É–µ—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è —É –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤.",
    "–ë–µ—Ä–µ–≥–∏ –≥–æ–ª–æ–≤—É –∏ —Å–µ—Ä–¥—Ü–µ: –≤ –ª—é–±—É—é –ø–æ–≥–æ–¥—É –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∞—Ç—å—Å—è —á–µ–ª–æ–≤–µ–∫–æ–º.",
    "–î–∞–∂–µ –µ—Å–ª–∏ –Ω–µ–±–æ —Å–ø–æ—Ä–∏—Ç ‚Äî —Å–≤–µ—á–∞ –≤—Å—ë —Ä–∞–≤–Ω–æ –≥–æ—Ä–∏—Ç.",
    "–ï—Å–ª–∏ —Å—Ç–∞–ª–æ —à—É–º–Ω–æ ‚Äî —Å–¥–µ–ª–∞–π —Ç–∏—à–µ –≤–Ω—É—Ç—Ä–∏. –≠—Ç–æ —Ç–æ–∂–µ –Ω–∞–≤—ã–∫.",
    "–ù–µ –æ—Ç–º–µ–Ω—è–π —Å–≤–µ—Ç –∏–∑-–∑–∞ –ø—Ä–æ–≥–Ω–æ–∑–∞. –î–æ–±–∞–≤—å –µ–≥–æ —Å–∞–º.",
]


def build_message(city: str, metrics: dict, top_articles: List[Article]) -> str:
    """
    –£—Å—Ç–æ–π—á–∏–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: –±–µ–∑ —Å–ª–æ–∂–Ω—ã—Ö –≤–µ—Ç–≤–ª–µ–Ω–∏–π, —á—Ç–æ–±—ã –Ω–µ –ª–æ–≤–∏—Ç—å return/indent –æ—à–∏–±–∫–∏.
    –ü—Ä–∏ —ç—Ç–æ–º —Ç–µ–∫—Å—Ç —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–Ω—ã–π (–º–Ω–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –±–ª–æ–∫–æ–≤ + —Å–ª—É—á–∞–π–Ω—ã–µ –≤—Å—Ç–∞–≤–∫–∏).
    """
    w = words(metrics)

    title = f"{pick(ANCHORS)}: {city}"
    voice = pick(VOICE_TAGS)
    opener = pick(OPENERS)

    morning = pick(MORNING_TEMPLATES).format(phenomenon=pick(PHENOMENA), desc=pick(DESCS))
    day = pick(DAY_TEMPLATES).format(day_event=pick(DAY_EVENTS), advice=pick(ADVICES))
    evening = pick(EVENING_TEMPLATES).format(evening=pick(EVENINGS), evening_desc=pick(EVENING_DESCS))

    metrics_block = pick(METRIC_TEMPLATES).format(temp=w["temp"], wind=w["wind"], press=w["press"])

    note = ""
    if int(metrics["n"]) == 0:
        note = (
            "\n‚ö†Ô∏è –≠—Ç–æ –Ω–µ –∑–Ω–∞—á–∏—Ç ¬´—Å–æ–±—ã—Ç–∏–π –Ω–µ –±—É–¥–µ—Ç¬ª. "
            "–≠—Ç–æ –∑–Ω–∞—á–∏—Ç: –∑–∞ 24 —á–∞—Å–∞ –≤ –Ω–æ–≤–æ—Å—Ç–Ω–æ–π –±–∞–∑–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π –ø–æ –∑–∞–ø—Ä–æ—Å—É "
            "(–≥–æ—Ä–æ–¥ + –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞)."
        )

    radar_block = (
        f"{pick(RADAR_HEADERS)}\n"
        + pick(RADAR_LINES).format(n=int(metrics["n"]))
        + note
    )

    conf_block = pick(CONF_TEMPLATES).format(conf=w["conf"])
    final = pick(FINALS)

    sections: List[str] = []
    sections.append(f"{title}\n{voice}")

    if maybe(0.65):
        sections.append(opener)

    # –ò–Ω–æ–≥–¥–∞ –º–µ–Ω—è–µ–º –ø–æ—Ä—è–¥–æ–∫ —Å–µ—Ä–µ–¥–∏–Ω—ã
    trio = [morning, day, evening]
    if maybe(0.25):
        random.shuffle(trio)
    if maybe(0.75):
        trio = [x for x in trio if x != evening] + [evening]
    sections.extend(trio)

    # –•–≤–æ—Å—Ç
    tail = [metrics_block, radar_block]
    if maybe(0.80):
        tail.append(conf_block)
    random.shuffle(tail)
    sections.extend(tail)

    # –í—Å—Ç–∞–≤–∫–∏
    if maybe(0.35):
        sections.append(pick(ASIDES))
    if maybe(0.25):
        sections.append(pick(MICRO_SECTIONS))

    sections.append(final)

    # –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –∏–Ω–æ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º
    if top_articles and maybe(0.72):
        lines = []
        for a in top_articles[:7]:
            lines.append(f"‚Ä¢ {a.title}\n  {a.url}")
        sections.append("üì∞ –û—Ç–∫—Ä—ã—Ç—ã–µ —Å–∏–≥–Ω–∞–ª—ã (24—á):\n" + "\n".join(lines))

    text = "\n\n".join(sections).strip()
    return text


# -----------------------------
# ROUTES
# -----------------------------
@router.message(Command("start"))
async def cmd_start(message: Message):
    await message.answer(
        "–§–æ—Ä–º–∞—Ç:\n"
        "‚Ä¢ /forecast Tallinn\n"
        "–Ø –∞–Ω–∞–ª–∏–∑–∏—Ä—É—é –ø—É–±–ª–∏—á–Ω—ã–µ –Ω–æ–≤–æ—Å—Ç–Ω—ã–µ —Å–∏–≥–Ω–∞–ª—ã –ø—Ä–æ–ø–∞–ª–µ—Å—Ç–∏–Ω—Å–∫–æ–≥–æ —Ç–æ–ª–∫–∞ –∑–∞ **–ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞** "
        "–∏ –≤—ã–¥–∞—é ¬´–ø–æ–≥–æ–¥–Ω—É—é¬ª —Å–≤–æ–¥–∫—É."
    )


@router.message(Command("forecast"))
async def cmd_forecast(message: Message):
    text = message.text or ""
    parts = text.split(maxsplit=1)
    if len(parts) < 2:
        await message.answer("–§–æ—Ä–º–∞—Ç: /forecast <city>\n–ü—Ä–∏–º–µ—Ä: /forecast Tallinn")
        return

    city = human_city(parts[1])

    async with aiohttp.ClientSession() as session:
        try:
            articles_24h = await gdelt_fetch_articles(session, city=city)
        except Exception as e:
            logger.warning("GDELT fetch failed: %r", e)
            articles_24h = []

    metrics = compute_metrics(articles_24h)
    top_articles = sorted(articles_24h, key=lambda a: a.seendate, reverse=True)

    await message.answer(build_message(city, metrics, top_articles), disable_web_page_preview=True)


# -----------------------------
# MAIN
# -----------------------------
async def main():
    bot = Bot(BOT_TOKEN)
    dp = Dispatcher()
    dp.include_router(router)
    logger.info("Bot started (polling)")
    await dp.start_polling(bot)


if __name__ == "__main__":
    try:
        asyncio.run(main())
    except KeyboardInterrupt:
        print("Stopped")
